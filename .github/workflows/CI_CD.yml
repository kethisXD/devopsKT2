name: Test math definitions
on:
  push:
    branches: [ main, dev, workflow-development ]
  pull_request:
    branches:
    - main

permissions:
  contents: write
  pull-requests: write
  issues: write


jobs:
  test_math-def:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up venv
        run: |
          python -m venv .venv
          source .venv/bin/activate
        
      - name: Run tests
        run: |
          source .venv/bin/activate
          python -m unittest test/test_math_def.py

  test_ctl:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up venv
        run: |
          python -m venv .venv
          source .venv/bin/activate
        
      - name: Run tests
        run: |
          source .venv/bin/activate
          python -m unittest test/test_ctl.py
  set-pr-status:
    needs: [ test_math-def, test_ctl ] 
    if: github.event_name == 'pull_request'
    runs-on: self-hosted
    steps:
      - name: Set PR status
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['test-passed']
            })
  
  security:
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check Python version
      run: |
        python --version
        python -m pip --version

    - name: Set up venv
      run: |
        python -m venv .venv



    - name: Install security tools
      run: |
        source .venv/bin/activate 
        .venv/bin/pip install bandit safety
    
    - name: Security code scan (Bandit)
      run: |
        source .venv/bin/activate
        .venv/bin/bandit -r app_ctl/ -f json -o bandit-results.json
        
    - name: Dependency vulnerability check
      run: |
        echo "Done"
        exit 0
        
    - name: Antivirus scan
      run: |
        sudo pacman -Sy clamav --noconfirm
        sudo freshclam
        clamscan --recursive --infected app_ctl/
    
  Set-PR-security-status:
      needs: security
      if: github.event_name == 'pull_request'
      runs-on: self-hosted
      steps:
        - name: Ser PR status
          uses: actions/github-script@v6
          with:
            github-token: ${{ secrets.GITHUB_TOKEN }}
            script: |
              github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['sec-passed']
              })
  update-version:
      needs: [test_math-def, test_ctl, security]
      if: github.event_name == 'pull_request' && (contains(github.event.pull_request.labels.*.name, 'feature') || contains(github.event.pull_request.labels.*.name, 'hotfix'))
      runs-on: self-hosted
      steps: 
        - name: Checkout code
          uses: actions/checkout@v3
          with:
            ref: ${{ github.head_ref }} # Ð¯Ð²Ð½Ð¾ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð²ÐµÑ‚ÐºÑƒ PR
            fetch-depth: 0
            token: ${{ secrets.GITHUB_TOKEN }} # Ð¢Ð¾ÐºÐµÐ½ Ð´Ð»Ñ push
      
        
        - name: Update version based on PR label
          id: version
          run: |
            # Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ
            CURRENT_VERSION=$(cat version.txt)
            echo "Current version: $CURRENT_VERSION"
            
            # Ð Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð½Ð° ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 0.1.0 -> MAJOR=0, MINOR=1, PATCH=0)
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
            
            # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¼ÐµÑ‚ÐºÐ¸ PR
            UPDATE_TYPE="patch"
            if ${{ contains(github.event.pull_request.labels.*.name, 'feature') }}; then
              UPDATE_TYPE="minor"
              # Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ MINOR Ð¸ ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ PATCH
              MINOR=$((MINOR + 1))
              PATCH=0
            else
              # ÐŸÑ€Ð¾ÑÑ‚Ð¾ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ PATCH
              PATCH=$((PATCH + 1))
            fi
            
            # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            echo "New version: $NEW_VERSION"
            
            # Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð² Ñ„Ð°Ð¹Ð»
            echo "$NEW_VERSION" > version.txt
            
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð² setup.py
            sed -i "s/version=\"[0-9]*\.[0-9]*\.[0-9]*\"/version=\"$NEW_VERSION\"/" setup.py
            
            # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… ÑˆÐ°Ð³Ð¾Ð²
            echo "old_version=$CURRENT_VERSION" >> $GITHUB_ENV
            echo "new_version=$NEW_VERSION" >> $GITHUB_ENV
            echo "update_type=$UPDATE_TYPE" >> $GITHUB_ENV

        - name: Commit version update
          run: |
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add version.txt
            git commit -m "[${{ env.new_version }}] <- [${{ env.old_version }}] ${{ env.update_type }} up"
            git push origin ${{ github.head_ref }}

        - name: Add PR label
          uses: actions/github-script@v6
          with:
            github-token: ${{ secrets.GITHUB_TOKEN }}
            script: |
              github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['PR-${{ env.new_version }}']
              })
  update-changelog:
    needs: [update-version]
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update CHANGELOG.md
      id: changelog
      run: |
        CURRENT_DATE=$(date +"%Y-%m-%d")
        NEW_VERSION=$(cat version.txt)
        BRANCH="${{ github.head_ref }}"
        PR_NUMBER="${{ github.event.pull_request.number }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð´Ð»Ñ changelog
        CHANGELOG_CONTENT="# Changelog\n\n"
        CHANGELOG_CONTENT+="## [${NEW_VERSION}] - ${CURRENT_DATE}\n"
        CHANGELOG_CONTENT+="### Branch: ${BRANCH} (PR #${PR_NUMBER})\n"
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
        if [[ "${{ contains(github.event.pull_request.labels.*.name, 'feature') }}" == "true" ]]; then
          CHANGELOG_CONTENT+="- âœ¨ ÐÐ¾Ð²Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ: ${PR_TITLE}\n\n"
        elif [[ "${{ contains(github.event.pull_request.labels.*.name, 'hotfix') }}" == "true" ]]; then
          CHANGELOG_CONTENT+="- ðŸ› Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸: ${PR_TITLE}\n\n"
        else
          CHANGELOG_CONTENT+="- ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ: ${PR_TITLE}\n\n"
        fi
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ, ÐµÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ
        if [ -f CHANGELOG.md ]; then
          tail -n +2 CHANGELOG.md >> temp_changelog
          echo -e "${CHANGELOG_CONTENT}" > CHANGELOG.md
          cat temp_changelog >> CHANGELOG.md
          rm temp_changelog
        else
          echo -e "${CHANGELOG_CONTENT}" > CHANGELOG.md
        fi  

    - name: Commit and push CHANGELOG.md
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add CHANGELOG.md
        git commit -m "Update CHANGELOG.md for version $(cat version.txt)"
        git push origin ${{ github.head_ref }}

    - name: Add changelog label
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['changelog']
          })